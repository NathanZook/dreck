#!/bin/bash

# two args given: issue/NUM or pull/NUM and version. We ignore the first.

GOLANG=https://dl.google.com/go/go1.10.3.linux-amd64.tar.gz

VERSION=$2
OWNER=miekg
DRECK=https://github.com/$OWNER/dreck
TAR=$(basename $GOLANG)
TEMP=$(mktemp -d)

function finish {
  rmdir -f $TEMP
}
trap finish EXIT

cd $TEMP
if [[ ! -e /tmp/$TAR ]]; then
    wget $GOLANG
    cp $TAR /tmp
else
    cp /tmp/$TAR .
fi

tar xf $TAR
export GOROOT=$PWD/go
PATH=$GOROOT/bin:$PATH
mkdir -p g/src/github.com/$OWNER
export GOPATH=$PWD/g

cd g/src/github.com/$OWNER && git clone --depth 1 $DRECK && cd $(basename $DRECK)
make godeps
go build

echo Releasing: $(VERSION)
gh-release create $(DRECK) $(VERSION)
