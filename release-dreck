#!/bin/bash

# This release script downloads the latest Go and dreck, sets things up and then calls
# into the Makefile to do the release.

LATEST=$(curl -s https://golang.org/VERSION?m=text)
GOLANG=https://dl.google.com/go/${LATEST}.linux-amd64.tar.gz
VERSION=$1

if [[ -z "$VERSION" ]]; then
    echo "No version given"
    exit 1
fi

if [[ -z "$GITHUB_ACCESS_TOKEN" ]]; then
    echo "No GITHUB_ACCESS_TOKEN set"
    exit 1
fi

GITHUB=miekg
DRECK=https://github.com/$GITHUB/dreck
TAR=$(basename $GOLANG)
TEMP=$(mktemp -d)

f1() { rm -rf $TEMP; }; trap f1 EXIT

#cd $TEMP
#if [[ ! -e /tmp/$TAR ]]; then
#    echo "downloading $GOLANG"
#    wget -q $GOLANG
#    cp $TAR /tmp
#else
#    cp /tmp/$TAR .
#fi

#tar xf $TAR
#export GOROOT=$PWD/go
#PATH=$GOROOT/bin:$PATH
#mkdir -p g/src/github.com/$GITHUB
#export GOPATH=$PWD/g

#cd g/src/github.com/$GITHUB && git clone --depth 1 $DRECK && cd $(basename $DRECK)
make VERSION=${VERSION} release
make VERSION=${VERSION} upload
